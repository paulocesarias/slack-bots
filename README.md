# Slack Bots - Claude Bot Provisioning

Web application for automating the creation of Claude-powered Slack bots with full n8n workflow integration.

## Features

- **Automated Bot Provisioning**: Create complete Claude Slack bots with one click
- **Linux User Management**: Creates isolated Linux users on the host system
- **SSH Key Generation**: Auto-generates SSH keypairs or accepts existing public keys
- **n8n Integration**: Creates credentials and clones workflow from template
- **Slack Integration**: Validates tokens and creates channels automatically
- **Google SSO**: Secure access with email/domain whitelisting

## How It Works

When you create a bot, the app automatically:

1. Validates your Slack Bot OAuth token
2. Creates a Slack channel for the bot
3. Creates a Linux user with SSH access
4. Generates an SSH keypair (or uses your provided public key)
5. Creates n8n SSH and Slack credentials
6. Clones the n8n workflow template with unique webhook URL
7. Configures the workflow with the new credentials and channel

## Prerequisites

- Docker and Docker Compose
- Traefik reverse proxy
- Google OAuth credentials
- n8n instance with API access
- A template n8n workflow for Slack bots

## Environment Variables

Create a `.env` file:

```bash
# Google OAuth Configuration
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Session Configuration
SESSION_SECRET=your-random-session-secret

# Access Control (comma-separated)
ALLOWED_EMAILS=user1@gmail.com
ALLOWED_DOMAINS=

# n8n API Configuration
N8N_API_ENDPOINT=https://n8n.example.com/api/v1
N8N_API_KEY=your-n8n-api-key
N8N_TEMPLATE_WORKFLOW_ID=your-template-workflow-id

# SSH Configuration
SSH_HOST=your-server-ip
SSH_PORT=22
```

## Creating a Slack App

Each bot requires its own Slack App (Event Subscriptions can only point to one webhook URL).

1. Go to [api.slack.com/apps](https://api.slack.com/apps)
2. Click **"Create New App"** → **"From an app manifest"**
3. Select your workspace and paste the manifest (generated by the app)
4. Click **"Create"** → **"Install to Workspace"**
5. Copy the **Bot User OAuth Token** (starts with `xoxb-`)
6. Create the bot in this app using the token
7. After the workflow is created in n8n:
   - Open the workflow and click on the Slack Trigger node
   - Copy the webhook URL (format: `https://n8n.example.com/webhook/{uuid}/webhook`)
   - Go back to your Slack App → **Event Subscriptions**
   - Enable events and paste the webhook URL as the Request URL

## Deployment

```bash
docker compose up -d
```

The app is deployed at https://slackbots.headbangtech.com

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                      Traefik                            │
│              (Reverse Proxy + TLS)                      │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────┐
│                  slack-bots                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Express.js Backend                  │   │
│  │  - Google OAuth (Passport.js)                   │   │
│  │  - Bot provisioning API                         │   │
│  │  - n8n API integration                          │   │
│  │  - Slack API integration                        │   │
│  │  - Linux user management                        │   │
│  │  - SSH key generation (node-forge)              │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │              React SPA Frontend                  │   │
│  │  - Bot creation form with Slack manifest helper │   │
│  │  - Bot management (activate/deactivate/delete)  │   │
│  │  - Google SSO login                             │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  SQLite                          │   │
│  │  - Bot records and status                       │   │
│  │  - Session storage                              │   │
│  └─────────────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────────────┘
         │              │
         │              │ n8n API
         │              ▼
         │   ┌─────────────────────────────────────────┐
         │   │              n8n                         │
         │   │  - SSH credentials                      │
         │   │  - Slack credentials                    │
         │   │  - Workflow templates                   │
         │   └─────────────────────────────────────────┘
         │
         │ Mounted Volumes (privileged)
         ▼
┌─────────────────────────────────────────────────────────┐
│                    Host System                          │
│  - /etc/passwd, /etc/shadow, /etc/group                │
│  - /home (for user directories)                        │
└─────────────────────────────────────────────────────────┘
```

## API Endpoints

### Public
- `GET /api/health` - Health check

### Authentication
- `GET /auth/google` - Initiate Google OAuth login
- `GET /auth/google/callback` - OAuth callback
- `GET /auth/me` - Get current user info
- `POST /auth/logout` - Logout

### Protected (requires authentication)
- `GET /api/bots` - List all bots
- `GET /api/bots/:id` - Get bot details
- `POST /api/bots` - Create a new bot
- `POST /api/bots/:id/activate` - Activate bot workflow
- `POST /api/bots/:id/deactivate` - Deactivate bot workflow
- `DELETE /api/bots/:id` - Delete bot and cleanup resources

## Security Notes

- The container runs in **privileged mode** to manage host system users
- Access is restricted via Google SSO with email/domain whitelisting
- Each bot gets an isolated Linux user with its own home directory
- SSH private keys are only shown once during generation
- n8n credentials are created with proper isolation
